-- TABLE CHERCHEUR
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE CHERCHEUR CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE CHERCHEUR (
    id_chercheur NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nom VARCHAR2(50) NOT NULL,
    prenom VARCHAR2(50) NOT NULL,
    specialite VARCHAR2(30) NOT NULL CHECK (specialite IN ('Biotech','IA','Physique','Chimie','Mathématiques','Autre')),
    date_embauche DATE
);

-- Trigger pour contrôler date_embauche
CREATE OR REPLACE TRIGGER trg_chercheur_date
BEFORE INSERT OR UPDATE ON CHERCHEUR
FOR EACH ROW
BEGIN
  IF :NEW.date_embauche > SYSDATE THEN
    RAISE_APPLICATION_ERROR(-20001, 'La date de embauche ne peut pas être future.');
  END IF;
END;
/

-- TABLE PROJET
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE PROJET CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE PROJET (
    id_projet NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    titre VARCHAR2(100) NOT NULL,
    domaine VARCHAR2(50) NOT NULL,
    budget NUMBER NOT NULL CHECK (budget > 0),
    date_debut DATE NOT NULL,
    date_fin DATE NOT NULL,
    id_chercheur_resp NUMBER NOT NULL,
    CONSTRAINT fk_projet_chercheur FOREIGN KEY (id_chercheur_resp) REFERENCES CHERCHEUR(id_chercheur),
    CONSTRAINT chk_date_fin CHECK (date_fin >= date_debut)
);

-- TABLE EQUIPEMENT
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE EQUIPEMENT CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE EQUIPEMENT (
    id_equipement NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nom VARCHAR2(100) NOT NULL,
    categorie VARCHAR2(50) NOT NULL,
    date_acquisition DATE NOT NULL,
    etat VARCHAR2(20) NOT NULL CHECK (etat IN ('Disponible','En maintenance','Hors service'))
);

-- Trigger pour contrôler date_acquisition <= SYSDATE
CREATE OR REPLACE TRIGGER trg_equipement_date
BEFORE INSERT OR UPDATE ON EQUIPEMENT
FOR EACH ROW
BEGIN
  IF :NEW.date_acquisition > SYSDATE THEN
    RAISE_APPLICATION_ERROR(-20002, 'La date de acquisition ne peut pas être future.');
  END IF;
END;
/

-- TABLE AFFECTATION_EQUIP
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE AFFECTATION_EQUIP CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE AFFECTATION_EQUIP (
    id_affect NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_projet NUMBER NOT NULL,
    id_equipement NUMBER NOT NULL,
    date_affectation DATE NOT NULL,
    duree_jours NUMBER NOT NULL CHECK (duree_jours > 0),
    CONSTRAINT fk_affect_projet FOREIGN KEY (id_projet) REFERENCES PROJET(id_projet),
    CONSTRAINT fk_affect_equip FOREIGN KEY (id_equipement) REFERENCES EQUIPEMENT(id_equipement)
);

-- TABLE EXPERIENCE
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE EXPERIENCE CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE EXPERIENCE (
    id_exp NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_projet NUMBER NOT NULL,
    titre_exp VARCHAR2(100) NOT NULL,
    date_realisation DATE NOT NULL,
    resultat VARCHAR2(4000),
    statut VARCHAR2(20) NOT NULL CHECK (statut IN ('En cours','Terminée','Annulée')),
    CONSTRAINT fk_exp_projet FOREIGN KEY (id_projet) REFERENCES PROJET(id_projet)
);

-- TABLE ECHANTILLON
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE ECHANTILLON CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE ECHANTILLON (
    id_echantillon NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_exp NUMBER NOT NULL,
    type_echantillon VARCHAR2(50) NOT NULL,
    date_prelevement DATE NOT NULL,
    mesure NUMBER NOT NULL CHECK (mesure >= 0),
    CONSTRAINT fk_echantillon_exp FOREIGN KEY (id_exp) REFERENCES EXPERIENCE(id_exp)
);

-- TABLE LOG_OPERATION
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE LOG_OPERATION CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE LOG_OPERATION (
    id_log NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    table_concernee VARCHAR2(50) NOT NULL,
    operation VARCHAR2(10) NOT NULL CHECK (operation IN ('INSERT','UPDATE','DELETE')),
    utilisateur VARCHAR2(50) NOT NULL,
    date_op DATE DEFAULT SYSDATE,
    description VARCHAR2(4000)
);
